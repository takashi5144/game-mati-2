// „Ç≤„Éº„É†„ÅÆ„É°„Ç§„É≥„ÇØ„É©„Çπ
import { Renderer } from './Renderer.js';
import { SceneManager } from './SceneManager.js';
import { CameraController } from './CameraController.js';
import { InputManager } from './InputManager.js';
import { UIManager } from '../ui/UIManager.js';
import { ResourceManager } from '../systems/ResourceManager.js';
import { BuildingSystem } from '../systems/BuildingSystem.js';
import { ResidentSystem } from '../systems/ResidentSystem.js';
import { TimeSystem } from '../systems/TimeSystem.js';
import { TerrainGenerator } from '../world/TerrainGenerator.js';
import { EventSystem } from '../systems/EventSystem.js';

export class Game {
    constructor(config) {
        this.config = config;
        this.isRunning = false;
        this.isPaused = false;
        this.gameSpeed = config.GAME.SPEED.NORMAL;
        this.lastTime = 0;
        this.deltaTime = 0;
        this.hasChanges = false;
        
        // „Ç≥„Ç¢„Ç∑„Çπ„ÉÜ„É†
        this.renderer = null;
        this.sceneManager = null;
        this.cameraController = null;
        this.inputManager = null;
        
        // „Ç≤„Éº„É†„Ç∑„Çπ„ÉÜ„É†
        this.uiManager = null;
        this.resourceManager = null;
        this.buildingSystem = null;
        this.residentSystem = null;
        this.timeSystem = null;
        this.terrainGenerator = null;
        this.eventSystem = null;
        
        // „Ç≤„Éº„É†Áä∂ÊÖã
        this.selectedObject = null;
        this.currentTool = null;
        this.buildMode = null;
    }

    async init() {
        console.log('üéÆ Game.init() ÈñãÂßã');
        
        // „É¨„É≥„ÉÄ„É©„Éº„ÅÆÂàùÊúüÂåñ
        this.renderer = new Renderer(this.config.GRAPHICS);
        this.renderer.init();
        
        // „Ç∑„Éº„É≥ÁÆ°ÁêÜ„ÅÆÂàùÊúüÂåñ
        this.sceneManager = new SceneManager();
        this.sceneManager.init();
        
        // „Ç´„É°„É©„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÅÆÂàùÊúüÂåñ
        this.cameraController = new CameraController(
            this.renderer.camera,
            this.renderer.domElement,
            this.config.CONTROLS.MOUSE
        );
        
        // ÂÖ•ÂäõÁÆ°ÁêÜ„ÅÆÂàùÊúüÂåñ
        this.inputManager = new InputManager(this.config.CONTROLS);
        this.inputManager.init(this.renderer.domElement);
        this.setupInputHandlers();
        
        // UIÁÆ°ÁêÜ„ÅÆÂàùÊúüÂåñ
        this.uiManager = new UIManager(this);
        this.uiManager.init();
        
        // „Ç≤„Éº„É†„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ
        await this.initGameSystems();
        
        // Âú∞ÂΩ¢„ÅÆÁîüÊàê
        await this.generateWorld();
        
        // ÂàùÊúüÂª∫Áâ©„ÅÆÈÖçÁΩÆ
        this.placeInitialBuildings();
        
        console.log('‚úÖ Game.init() ÂÆå‰∫Ü');
    }

    async initGameSystems() {
        // „É™„ÇΩ„Éº„ÇπÁÆ°ÁêÜ
        this.resourceManager = new ResourceManager(this.config.INITIAL_RESOURCES);
        
        // ÊôÇÈñì„Ç∑„Çπ„ÉÜ„É†
        this.timeSystem = new TimeSystem(this.config.SEASONS);
        this.timeSystem.on('dayChanged', (day) => this.onDayChanged(day));
        this.timeSystem.on('seasonChanged', (season) => this.onSeasonChanged(season));
        
        // Âª∫Áâ©„Ç∑„Çπ„ÉÜ„É†
        this.buildingSystem = new BuildingSystem(
            this.sceneManager.scene,
            this.config.BUILDINGS
        );
        
        // ‰ΩèÊ∞ë„Ç∑„Çπ„ÉÜ„É†
        this.residentSystem = new ResidentSystem(
            this.sceneManager.scene,
            this.config.PROFESSIONS,
            this.config.NEEDS
        );
        
        // „Ç§„Éô„É≥„Éà„Ç∑„Çπ„ÉÜ„É†
        this.eventSystem = new EventSystem(this.config.EVENTS);
        this.eventSystem.on('eventTriggered', (event) => this.onEventTriggered(event));
    }

    async generateWorld() {
        console.log('üåç „ÉØ„Éº„É´„ÉâÁîüÊàêÈñãÂßã');
        
        this.terrainGenerator = new TerrainGenerator(
            this.config.TERRAIN,
            this.sceneManager.scene
        );
        
        await this.terrainGenerator.generate();
        
        // „É©„Ç§„ÉÜ„Ç£„É≥„Ç∞„ÅÆË®≠ÂÆö
        this.setupLighting();
        
        console.log('‚úÖ „ÉØ„Éº„É´„ÉâÁîüÊàêÂÆå‰∫Ü');
    }

    setupLighting() {
        const scene = this.sceneManager.scene;
        
        // Áí∞Â¢ÉÂÖâ
        const ambientLight = new THREE.HemisphereLight(
            0x87CEEB, // Á©∫„ÅÆËâ≤
            0x497749, // Âú∞Èù¢„ÅÆËâ≤
            0.4
        );
        scene.add(ambientLight);
        
        // Â§™ÈôΩÂÖâ
        const sunLight = new THREE.DirectionalLight(0xFFFFFF, 1.0);
        sunLight.position.set(50, 100, 50);
        sunLight.castShadow = true;
        
        // „Ç∑„É£„Éâ„Ç¶„Éû„ÉÉ„Éó„ÅÆË®≠ÂÆö
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.near = 0.5;
        sunLight.shadow.camera.far = 500;
        sunLight.shadow.camera.left = -100;
        sunLight.shadow.camera.right = 100;
        sunLight.shadow.camera.top = 100;
        sunLight.shadow.camera.bottom = -100;
        
        scene.add(sunLight);
        this.sceneManager.sunLight = sunLight;
        
        // „Éï„Ç©„Ç∞
        if (this.config.GRAPHICS.environment.fog.enabled) {
            scene.fog = new THREE.Fog(
                this.config.GRAPHICS.environment.fog.color,
                this.config.GRAPHICS.environment.fog.near,
                this.config.GRAPHICS.environment.fog.far
            );
        }
    }

    placeInitialBuildings() {
        console.log('üè† ÂàùÊúüÂª∫Áâ©ÈÖçÁΩÆ');
        
        const centerX = this.config.TERRAIN.SIZE / 2;
        const centerZ = this.config.TERRAIN.SIZE / 2;
        
        // Á¥çÂ±ã„Çí‰∏≠Â§Æ„Å´ÈÖçÁΩÆ
        this.buildingSystem.placeBuilding(centerX, centerZ, 'barn', true);
        
        // ÂÆ∂„ÇíÈÖçÁΩÆ
        this.buildingSystem.placeBuilding(centerX - 5, centerZ, 'house', true);
        
        // Áïë„ÇíÈÖçÁΩÆ
        this.buildingSystem.placeBuilding(centerX, centerZ - 5, 'farm', true);
        this.buildingSystem.placeBuilding(centerX + 3, centerZ - 5, 'farm', true);
        
        // ÂàùÊúü‰ΩèÊ∞ë„ÇíÁîüÊàê
        this.residentSystem.spawnResident(centerX - 2, centerZ, 'none', '‰ΩèÊ∞ë‚ë†');
        this.residentSystem.spawnResident(centerX + 2, centerZ, 'none', '‰ΩèÊ∞ë‚ë°');
        
        // „É™„ÇΩ„Éº„Çπ„ÇíÊõ¥Êñ∞
        this.uiManager.updateResourceDisplay(this.resourceManager.resources);
        this.uiManager.updatePopulation(
            this.residentSystem.getPopulation(),
            this.residentSystem.getMaxPopulation()
        );
    }

    setupInputHandlers() {
        // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
        this.inputManager.on('mousedown', (e) => this.onMouseDown(e));
        this.inputManager.on('mouseup', (e) => this.onMouseUp(e));
        this.inputManager.on('mousemove', (e) => this.onMouseMove(e));
        this.inputManager.on('wheel', (e) => this.onMouseWheel(e));
        this.inputManager.on('click', (e) => this.onClick(e));
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà
        this.inputManager.on('keydown', (e) => this.onKeyDown(e));
        
        // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
        this.inputManager.on('touchstart', (e) => this.onTouchStart(e));
        this.inputManager.on('touchmove', (e) => this.onTouchMove(e));
        this.inputManager.on('touchend', (e) => this.onTouchEnd(e));
    }

    // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
    onMouseDown(event) {
        if (event.button === 0) { // Â∑¶„ÇØ„É™„ÉÉ„ÇØ
            if (this.currentTool && this.isAreaTool(this.currentTool)) {
                this.startAreaSelection(event);
            }
        }
        this.cameraController.onMouseDown(event);
    }

    onMouseUp(event) {
        if (this.isSelectingArea) {
            this.completeAreaSelection();
        }
        this.cameraController.onMouseUp(event);
    }

    onMouseMove(event) {
        if (this.isSelectingArea) {
            this.updateAreaSelection(event);
        }
        this.cameraController.onMouseMove(event);
        
        // „Éõ„Éê„ÉºÂäπÊûú„ÅÆÊõ¥Êñ∞
        this.updateHoverEffect(event);
    }

    onMouseWheel(event) {
        this.cameraController.onMouseWheel(event);
    }

    onClick(event) {
        if (event.button === 2) { // Âè≥„ÇØ„É™„ÉÉ„ÇØ
            this.cancelCurrentTool();
            return;
        }
        
        if (event.button === 0 && !this.cameraController.isDragging) { // Â∑¶„ÇØ„É™„ÉÉ„ÇØ
            this.handleClick(event);
        }
    }

    // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
    onKeyDown(event) {
        const key = event.key.toUpperCase();
        const action = this.config.CONTROLS.KEYBOARD[key];
        
        if (!action) return;
        
        switch (action) {
            case 'pause_toggle':
                this.togglePause();
                break;
            case 'speed_normal':
                this.setGameSpeed(this.config.GAME.SPEED.NORMAL);
                break;
            case 'speed_fast':
                this.setGameSpeed(this.config.GAME.SPEED.FAST);
                break;
            case 'speed_very_fast':
                this.setGameSpeed(this.config.GAME.SPEED.VERY_FAST);
                break;
            case 'toggle_build_menu':
                this.uiManager.toggleBuildMenu();
                break;
            case 'toggle_resident_panel':
                this.uiManager.toggleResidentPanel();
                break;
            case 'cancel':
                this.cancelCurrentTool();
                break;
            default:
                // „Ç´„É°„É©„Ç≥„É≥„Éà„É≠„Éº„É´
                if (action.startsWith('camera_')) {
                    this.cameraController.handleKeyboard(action);
                }
                // „ÉÑ„Éº„É´„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
                else if (action.startsWith('tool_')) {
                    const tool = action.replace('tool_', '');
                    this.setCurrentTool(tool);
                }
                break;
        }
    }

    // „Ç≤„Éº„É†„É´„Éº„Éó
    start() {
        this.isRunning = true;
        this.lastTime = performance.now();
        this.gameLoop();
        console.log('üéÆ „Ç≤„Éº„É†ÈñãÂßã');
    }

    stop() {
        this.isRunning = false;
        console.log('üõë „Ç≤„Éº„É†ÂÅúÊ≠¢');
    }

    gameLoop() {
        if (!this.isRunning) return;
        
        requestAnimationFrame(() => this.gameLoop());
        
        const currentTime = performance.now();
        this.deltaTime = (currentTime - this.lastTime) / 1000;
        this.lastTime = currentTime;
        
        if (!this.isPaused) {
            this.update(this.deltaTime * this.gameSpeed);
        }
        
        this.render();
    }

    update(deltaTime) {
        // „Ç´„É°„É©„ÅÆÊõ¥Êñ∞
        this.cameraController.update(deltaTime);
        
        // „Ç≤„Éº„É†„Ç∑„Çπ„ÉÜ„É†„ÅÆÊõ¥Êñ∞
        this.timeSystem.update(deltaTime);
        this.residentSystem.update(deltaTime);
        this.buildingSystem.update(deltaTime);
        this.resourceManager.update(deltaTime, this.residentSystem.getPopulation());
        this.eventSystem.update(deltaTime);
        
        // UI„ÅÆÊõ¥Êñ∞
        this.uiManager.update(deltaTime);
    }

    render() {
        this.renderer.render(this.sceneManager.scene, this.renderer.camera);
    }

    // „Ç≤„Éº„É†Áä∂ÊÖãÁÆ°ÁêÜ
    togglePause() {
        this.isPaused = !this.isPaused;
        this.uiManager.updatePauseButton(this.isPaused);
        console.log(this.isPaused ? '‚è∏Ô∏è „Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢' : '‚ñ∂Ô∏è „Ç≤„Éº„É†ÂÜçÈñã');
    }

    setGameSpeed(speed) {
        this.gameSpeed = speed;
        this.uiManager.updateSpeedButtons(speed);
        console.log(`‚è© „Ç≤„Éº„É†ÈÄüÂ∫¶: ${speed}x`);
    }

    setCurrentTool(tool) {
        this.currentTool = tool;
        this.buildMode = tool;
        this.uiManager.updateToolSelection(tool);
        
        // „Ç´„Éº„ÇΩ„É´„ÅÆÊõ¥Êñ∞
        const cursorType = this.getToolCursor(tool);
        this.renderer.domElement.style.cursor = cursorType;
    }

    cancelCurrentTool() {
        this.currentTool = null;
        this.buildMode = null;
        this.uiManager.updateToolSelection(null);
        this.renderer.domElement.style.cursor = 'grab';
    }

    // „ÉÑ„Éº„É´Èñ¢ÈÄ£„ÅÆ„Éò„É´„Éë„Éº„É°„ÇΩ„ÉÉ„Éâ
    isAreaTool(tool) {
        return ['harvest-area', 'farm-zone', 'clear-area', 'stockpile'].includes(tool);
    }

    getToolCursor(tool) {
        if (this.isAreaTool(tool)) return 'crosshair';
        if (tool === 'demolish') return 'not-allowed';
        if (tool) return 'pointer';
        return 'grab';
    }

    // „ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
    handleClick(event) {
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        const rect = this.renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        
        raycaster.setFromCamera(mouse, this.renderer.camera);
        
        // Âú∞ÂΩ¢„Å®„ÅÆ‰∫§Â∑ÆÂà§ÂÆö
        const intersects = raycaster.intersectObjects(this.sceneManager.scene.children, true);
        
        if (intersects.length > 0) {
            const point = intersects[0].point;
            const object = intersects[0].object;
            
            // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÁ®ÆÈ°û„Å´Âøú„Åò„Å¶Âá¶ÁêÜ
            if (object.userData.type === 'terrain') {
                this.handleTerrainClick(point.x, point.z);
            } else if (object.userData.type === 'building') {
                this.handleBuildingClick(object.userData.building);
            } else if (object.userData.type === 'resident') {
                this.handleResidentClick(object.userData.resident);
            }
        }
    }

    handleTerrainClick(x, z) {
        if (this.currentTool) {
            // Âª∫Áâ©ÈÖçÁΩÆ
            if (this.config.BUILDINGS[this.currentTool.toUpperCase()]) {
                this.tryPlaceBuilding(x, z, this.currentTool);
            }
        }
    }

    handleBuildingClick(building) {
        this.selectObject(building);
        this.uiManager.showBuildingInfo(building);
    }

    handleResidentClick(resident) {
        this.selectObject(resident);
        this.uiManager.showResidentInfo(resident);
    }

    tryPlaceBuilding(x, z, buildingType) {
        const config = this.config.BUILDINGS[buildingType.toUpperCase()];
        
        // Ë≥áÊ∫ê„ÉÅ„Çß„ÉÉ„ÇØ
        if (!this.resourceManager.canAfford(config.cost)) {
            this.uiManager.showNotification('Ë≥áÊ∫ê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
            return;
        }
        
        // ÈÖçÁΩÆÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (!this.buildingSystem.canPlaceAt(x, z, buildingType)) {
            this.uiManager.showNotification('„Åì„Åì„Å´„ÅØÂª∫Ë®≠„Åß„Åç„Åæ„Åõ„Çì', 'error');
            return;
        }
        
        // Âª∫Áâ©„ÇíÈÖçÁΩÆ
        const building = this.buildingSystem.placeBuilding(x, z, buildingType);
        if (building) {
            this.resourceManager.consume(config.cost);
            this.uiManager.showNotification(`${config.name}„ÅÆÂª∫Ë®≠„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü`, 'success');
            this.hasChanges = true;
        }
    }

    // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
    onDayChanged(day) {
        this.uiManager.updateDate(day);
    }

    onSeasonChanged(season) {
        this.uiManager.updateSeason(season);
        // Â≠£ÁØÄ„Å´Âøú„Åò„ÅüÁí∞Â¢ÉÂ§âÊõ¥
        this.updateEnvironmentForSeason(season);
    }

    onEventTriggered(event) {
        this.uiManager.showEventNotification(event);
        // „Ç§„Éô„É≥„Éà„ÅÆÂäπÊûú„ÇíÈÅ©Áî®
        this.applyEventEffects(event);
    }

    updateEnvironmentForSeason(season) {
        const config = this.config.SEASONS[season];
        // „É©„Ç§„ÉÜ„Ç£„É≥„Ç∞„ÅÆË™øÊï¥
        if (this.sceneManager.sunLight) {
            const intensity = season === 'WINTER' ? 0.6 : 1.0;
            this.sceneManager.sunLight.intensity = intensity;
        }
        // „Éï„Ç©„Ç∞„ÅÆËâ≤Ë™øÊï¥
        if (this.sceneManager.scene.fog) {
            this.sceneManager.scene.fog.color.setHex(config.color);
        }
    }

    applyEventEffects(event) {
        // „Ç§„Éô„É≥„Éà„ÅÆÂäπÊûú„ÇíÂÆüË£Ö
        console.log('„Ç§„Éô„É≥„ÉàÂäπÊûúÈÅ©Áî®:', event);
    }

    // „Åù„ÅÆ‰ªñ„ÅÆ„É°„ÇΩ„ÉÉ„Éâ
    hasUnsavedChanges() {
        return this.hasChanges;
    }

    onWindowResize() {
        this.renderer.onWindowResize();
        this.cameraController.onWindowResize();
    }

    // „Ç®„É™„Ç¢ÈÅ∏ÊäûÈñ¢ÈÄ£
    startAreaSelection(event) {
        this.isSelectingArea = true;
        this.selectionStart = { x: event.clientX, y: event.clientY };
        this.uiManager.showSelectionBox(this.selectionStart.x, this.selectionStart.y);
    }

    updateAreaSelection(event) {
        if (!this.isSelectingArea) return;
        this.uiManager.updateSelectionBox(
            this.selectionStart.x,
            this.selectionStart.y,
            event.clientX,
            event.clientY
        );
    }

    completeAreaSelection() {
        if (!this.isSelectingArea) return;
        this.isSelectingArea = false;
        this.uiManager.hideSelectionBox();
        
        // „Ç®„É™„Ç¢ÂÜÖ„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂá¶ÁêÜ
        // TODO: ÂÆüË£Ö
    }

    updateHoverEffect(event) {
        // „Éõ„Éê„ÉºÂäπÊûú„ÅÆÂÆüË£Ö
        // TODO: ÂÆüË£Ö
    }

    selectObject(object) {
        if (this.selectedObject) {
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
        }
        this.selectedObject = object;
        // ÈÅ∏Êäû„Ç®„Éï„Çß„ÇØ„Éà„ÇíËøΩÂä†
    }
}